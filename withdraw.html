<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - BluStone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui; background: #fafafa; padding: 20px; margin-bottom: 60px; }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 60px; }
        
        .page-header { margin-bottom: 32px; }
        .page-header h1 { font-size: 28px; color: #0f172a; margin-bottom: 8px; font-weight: 700; }
        .page-header p { color: #64748b; font-size: 15px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
        .stat-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,.05); border: 1px solid #e5e7eb; }
        .stat-label { font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 8px; }
        .stat-desc { font-size: 13px; color: #94a3b8; }
        
        .info-banner { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 14px; margin-bottom: 24px; font-size: 14px; color: #0c4a6e; display: flex; gap: 12px; align-items: flex-start; }
        .info-banner i { color: #0284c7; flex-shrink: 0; margin-top: 2px; }
        
        .content-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,.05); border: 1px solid #e5e7eb; overflow: hidden; }
        
        .section-title { font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .section-title i { color: #10b981; font-size: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; transition: all .3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,.1); }
        .form-input::placeholder { color: #cbd5e1; }
        
        .balance-info { background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 8px; padding: 14px; margin-bottom: 20px; }
        .balance-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .balance-label { color: #166534; font-weight: 500; }
        .balance-value { color: #15803d; font-weight: 700; }
        
        .fee-info { background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 13px; color: #92400e; display: none; }
        .fee-info.show { display: block; }
        
        .alert { border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 14px; display: none; }
        .alert.show { display: block; }
        .alert-error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
        .alert-success { background: #f0fdf4; border: 1px solid #86efac; color: #166534; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 24px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all .3s; }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16,185,129,.3); width: 100%; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,.4); }
        .btn-primary:disabled { opacity: .6; cursor: not-allowed; }
        .btn-secondary { flex: 1; background: #f1f5f9; color: #475569; }
        .btn-secondary:active { background: #e2e8f0; }
        
        .history-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .history-table thead { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .history-table th { padding: 10px 12px; text-align: left; font-weight: 600; color: #475569; font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
        .history-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #334155; overflow: hidden; text-overflow: ellipsis; }
        .history-table tbody tr:hover { background: #f8fafc; }
        
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-completed { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        
        .empty-history { text-align: center; padding: 40px 20px; color: #94a3b8; }
        .empty-history i { font-size: 48px; color: #cbd5e1; margin-bottom: 12px; display: block; }
        
        /* Modal */
        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: 100vh; background: rgba(0,0,0,.5); z-index: 10000; animation: fadeIn .3s; }
        .modal.active { display: flex; align-items: flex-end; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content { width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp .4s; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 20px; font-weight: 700; color: #0f172a; }
        .modal-close { background: none; border: none; font-size: 28px; color: #64748b; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; transition: background .3s; }
        .modal-close:hover { background: #f1f5f9; }
        
        .mobile-btn { display: none; margin-bottom: 24px; width: 100%; }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stat-value { font-size: 28px; }
            .content-wrapper { grid-template-columns: 1fr; }
            .desktop-form { display: none !important; }
            .mobile-btn { display: block !important; }
            .modal { display: none !important; }
        }
        
        @media (min-width: 769px) {
            .mobile-btn { display: none !important; }
            .modal { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1>Withdraw Funds</h1>
            <p>Request a withdrawal from your investment account</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Available Balance</div>
                <div class="stat-value" id="available">$0.00</div>
                <div class="stat-desc">Total available to withdraw</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Withdrawn</div>
                <div class="stat-value" id="totalWithdrawn">$0.00</div>
                <div class="stat-desc">Lifetime withdrawals</div>
            </div>
        </div>

        <!-- Mobile Button -->
        <button class="btn btn-primary mobile-btn" id="openModal">
            <i class="fas fa-arrow-down"></i> Request Withdrawal
        </button>

        <!-- Info Banner -->
        <div class="info-banner">
            <i class="fas fa-info-circle"></i>
            <div><strong>Processing:</strong> Withdrawals are processed within 2-5 business days. A 2.5% processing fee applies.</div>
        </div>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Desktop Form -->
            <div class="section desktop-form">
                <div class="section-title">
                    <i class="fas fa-wallet"></i>
                    Request Withdrawal
                </div>

                <div class="alert alert-error" id="desktopError"></div>
                <div class="alert alert-success" id="desktopSuccess"></div>

                <div class="form-group">
                    <label class="form-label">Available Balance</label>
                    <div class="balance-info">
                        <div class="balance-row">
                            <span class="balance-label">Total Available:</span>
                            <span class="balance-value" id="desktopAvail">$0.00</span>
                        </div>
                    </div>
                </div>

                <form id="desktopForm">
                    <div class="form-group">
                        <label class="form-label">Withdrawal Amount</label>
                        <input type="number" class="form-input desktopAmount" placeholder="Enter amount" step="0.01" min="10" required>
                    </div>

                    <div class="fee-info" id="desktopFeeInfo">
                        <strong>Processing Fee:</strong> <span id="desktopFeeAmount">$0.00</span> (2.5%)
                    </div>

                    <div class="form-group">
                        <label class="form-label">Withdrawal Method</label>
                        <select class="form-select desktopMethod" required>
                            <option value="">Select withdrawal method</option>
                            <option value="btc">BTC Wallet Address</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Wallet Address</label>
                        <input type="text" class="form-input desktopAccount" placeholder="Enter wallet address" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <input type="text" class="form-input desktopNotes" placeholder="Any additional information...">
                    </div>

                    <button type="submit" class="btn btn-primary">Request Withdrawal</button>
                </form>
            </div>

            <!-- History -->
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    Withdrawal History
                </div>

                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -24px; padding: 0 24px;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Fee</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="4" class="empty-history">
                                    <i class="fas fa-inbox"></i>
                                    No withdrawal history yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Withdrawal</h2>
                <button class="modal-close" id="closeModal">âœ•</button>
            </div>

            <div class="alert alert-error" id="modalError"></div>
            <div class="alert alert-success" id="modalSuccess"></div>

            <div class="form-group">
                <label class="form-label">Available Balance</label>
                <div class="balance-info">
                    <div class="balance-row">
                        <span class="balance-label">Total Available:</span>
                        <span class="balance-value" id="modalAvail">$0.00</span>
                    </div>
                </div>
            </div>

            <form id="modalForm">
                <div class="form-group">
                    <label class="form-label">Withdrawal Amount</label>
                    <input type="number" class="form-input modalAmount" placeholder="Enter amount" step="0.01" min="10" required>
                </div>

                <div class="fee-info" id="modalFeeInfo">
                    <strong>Processing Fee:</strong> <span id="modalFeeAmount">$0.00</span> (2.5%)
                </div>

                <div class="form-group">
                    <label class="form-label">Withdrawal Method</label>
                    <select class="form-select modalMethod" required>
                        <option value="">Select withdrawal method</option>
                        <option value="btc">BTC Wallet Address</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-input modalAccount" placeholder="Enter wallet address" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-input modalNotes" placeholder="Any additional information...">
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Request Withdrawal</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getDatabase, ref, get, set, push, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import { auth, database } from "./lib/firebase.js";

        let user = null, userData = null;
        const modal = document.getElementById('withdrawModal');

        // Modal Controls
        const closeModal = () => {
            modal.classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('modalForm').reset();
            document.getElementById('modalError').classList.remove('show');
            document.getElementById('modalSuccess').classList.remove('show');
            document.getElementById('modalFeeInfo').classList.remove('show');
        };

        document.getElementById('openModal').onclick = () => {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (userData) {
                document.getElementById('modalAvail').textContent = `$${userData.available.toFixed(2)}`;
            }
        };

        document.getElementById('closeModal').onclick = closeModal;
        document.getElementById('cancelModal').onclick = closeModal;
        modal.onclick = (e) => e.target === modal && closeModal();

        // Fee Calculator
        const setupFeeListener = (inputClass, warningId, feeId) => {
            document.querySelectorAll(`.${inputClass}`).forEach(input => {
                input.addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    const feeWarning = document.getElementById(warningId);
                    const feeAmount = document.getElementById(feeId);
                    if (amount > 0) {
                        feeAmount.textContent = `$${(amount * 0.025).toFixed(2)}`;
                        feeWarning.classList.add('show');
                    } else {
                        feeWarning.classList.remove('show');
                    }
                });
            });
        };

        setupFeeListener('desktopAmount', 'desktopFeeInfo', 'desktopFeeAmount');
        setupFeeListener('modalAmount', 'modalFeeInfo', 'modalFeeAmount');

        // Load User Data
        onAuthStateChanged(auth, async (u) => {
            if (!u) return window.location.href = '/login';
            user = u;
            try {
                const snapshot = await get(ref(database, `users/${u.uid}`));
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    const balance = (userData.available || 0).toFixed(2);
                    document.getElementById('available').textContent = `$${balance}`;
                    document.getElementById('desktopAvail').textContent = `$${balance}`;
                    document.getElementById('modalAvail').textContent = `$${balance}`;
                    loadHistory(u.uid);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        });

    
        // Handle Submissions
        const handleSubmit = async (e, isModal) => {
            e.preventDefault();
            const prefix = isModal ? 'modal' : 'desktop';
            const form = e.target;
            
            const amount = parseFloat(document.querySelector(`.${prefix}Amount`).value);
            const method = document.querySelector(`.${prefix}Method`).value;
            const account = document.querySelector(`.${prefix}Account`).value;
            const notes = document.querySelector(`.${prefix}Notes`).value;
            
            const errorEl = document.getElementById(`${prefix}Error`);
            const successEl = document.getElementById(`${prefix}Success`);
            const submitBtn = form.querySelector('button[type="submit"]');

            errorEl.classList.remove('show');
            successEl.classList.remove('show');

            if (amount < 10) {
                errorEl.textContent = 'Minimum withdrawal amount is $10';
                errorEl.classList.add('show');
                return;
            }

            if (!userData || amount > (userData.available || 0)) {
                errorEl.textContent = 'Insufficient balance';
                errorEl.classList.add('show');
                return;
            }

            if (!method || !account) {
                errorEl.textContent = 'Please fill in all required fields';
                errorEl.classList.add('show');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const fee = amount * 0.025;
                const timestamp = new Date().toISOString();
                const withdrawalId = push(ref(database, 'pendingWithdrawals')).key;

                const withdrawalData = {
                    userId: user.uid,
                    userName: userData.name || 'User',
                    userEmail: user.email,
                    amount: amount,
                    fee: fee,
                    method: method,
                    btcAddress: account,
                    notes: notes,
                    status: 'pending',
                    requestDate: timestamp
                };

                await set(ref(database, `pendingWithdrawals/${withdrawalId}`), withdrawalData);

                const transactionData = {
                    type: 'withdrawal',
                    amount: amount,
                    fee: fee,
                    status: 'pending',
                    btcAddress: account,
                    method: method,
                    requestDate: timestamp
                };

                const userSnapshot = await get(ref(database, `users/${user.uid}`));
                const currentData = userSnapshot.val();

                await update(ref(database), {
                    [`users/${user.uid}/available`]: Math.max(0, (currentData.available || 0) - amount),
                    [`users/${user.uid}/totalBalance`]: Math.max(0, (currentData.totalBalance || 0) - amount),
                    [`users/${user.uid}/transactions/${withdrawalId}`]: transactionData
                });

                userData.available -= amount;
                document.getElementById('available').textContent = `$${userData.available.toFixed(2)}`;
                document.getElementById('desktopAvail').textContent = `$${userData.available.toFixed(2)}`;
                document.getElementById('modalAvail').textContent = `$${userData.available.toFixed(2)}`;

                successEl.textContent = 'Withdrawal request submitted successfully!';
                successEl.classList.add('show');

                await loadHistory(user.uid);

                setTimeout(() => {
                    if (isModal) closeModal();
                    form.reset();
                }, 2000);
            } catch (error) {
                console.error('Withdrawal error:', error);
                errorEl.textContent = error.message || 'An error occurred';
                errorEl.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Request Withdrawal';
            }
        };

        document.getElementById('desktopForm').onsubmit = (e) => handleSubmit(e, false);
        document.getElementById('modalForm').onsubmit = (e) => handleSubmit(e, true);

        // Load History
        const loadHistory = async (uid) => {
            try {
                const snapshot = await get(ref(database, `users/${uid}`));
                if (!snapshot.exists()) return;

                const transactions = snapshot.val().transactions || {};
                const withdrawals = Object.values(transactions)
                    .filter(t => t.type === 'withdrawal')
                    .sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

                if (withdrawals.length > 0) {
                    document.getElementById('historyBody').innerHTML = withdrawals.map(w => `
                        <tr>
                            <td>${new Date(w.requestDate).toLocaleDateString()}</td>
                            <td>$${w.amount.toFixed(2)}</td>
                            <td><span class="status-badge badge-${w.status}">${w.status}</span></td>
                            <td>$${w.fee.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    const completedTotal = withdrawals
                        .filter(w => w.status === 'completed')
                        .reduce((sum, w) => sum + w.amount, 0);
                    document.getElementById('totalWithdrawn').textContent = `$${completedTotal.toFixed(2)}`;
                } else {
                    document.getElementById('historyBody').innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-history">
                                <i class="fas fa-inbox"></i>
                                No withdrawal history yet
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        };
    </script>
</body>
</html>
