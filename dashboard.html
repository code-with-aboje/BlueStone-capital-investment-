<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #fafafa; min-height: 100vh; padding: 60px 20px 100px 20px; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 200px; }

        .dashboard-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 24px; padding: 24px; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.25), 0 2px 8px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .dashboard-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, transparent 40%, rgba(255, 255, 255, 0.25) 50%, transparent 60%, transparent); animation: shine 3s infinite; }
        @keyframes shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        .card-content { position: relative; z-index: 1; }
        .top-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; }
        .user-name { color: white; font-size: 18px; font-weight: 600; flex: 1; }
        .fund-button { background: white; color: #10b981; border: none; border-radius: 8px; padding: 6px 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); white-space: nowrap; flex-shrink: 0; }
        .fund-button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .balance-section { margin-top: 8px; }
        .balance-label { color: rgba(255, 255, 255, 0.85); font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .balance-amount { color: white; font-size: 36px; font-weight: 700; margin-bottom: 6px; }
        .balance-change { color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .stat-label { color: #64748b; font-size: 12px; font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { color: #0f172a; font-size: 20px; font-weight: 700; }
        .stat-trend { color: #10b981; font-size: 11px; font-weight: 600; margin-top: 4px; }

        .pending-section { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); margin-bottom: 20px; }
        .pending-title { font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .pending-title i { color: #f59e0b; font-size: 18px; }
        .pending-amount { text-align: center; padding: 20px; background: #fef3c7; border-radius: 12px; margin-bottom: 16px; }
        .pending-label { color: #92400e; font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        .pending-value { color: #f59e0b; font-size: 32px; font-weight: 700; }
        .claim-all-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase; }
        .claim-all-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        .claim-all-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }

        .plans-section { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); margin-bottom: 20px; }
        .plans-title { font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .plans-title i { color: #10b981; }
        .no-plans { text-align: center; padding: 20px; color: #94a3b8; font-size: 14px; }
        
        .plan-item { background: #f8fafc; border-left: 4px solid #10b981; border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        .plan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .plan-info h4 { color: #0f172a; font-size: 14px; margin-bottom: 4px; font-weight: 600; }
        .plan-info p { color: #64748b; font-size: 12px; }
        .plan-amount { text-align: right; }
        .plan-amount .value { color: #10b981; font-size: 16px; font-weight: 700; }
        .plan-amount .return { color: #059669; font-size: 12px; margin-top: 4px; }
        
        .plan-progress { margin: 10px 0; }
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.5s ease; }
        .progress-info { display: flex; justify-content: space-between; font-size: 11px; color: #64748b; }
        
        .earnings-row { display: flex; justify-content: space-between; margin: 10px 0; padding-top: 10px; border-top: 1px solid #e2e8f0; }
        .earning-item { text-align: center; flex: 1; }
        .earning-label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        .earning-value { font-size: 14px; font-weight: 700; }
        .earning-value.pending { color: #f59e0b; }
        .earning-value.claimed { color: #10b981; }
        
        .claim-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .claim-btn:hover:not(:disabled) { opacity: 0.9; }
        .claim-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }

        .claim-where { background: #e0f2fe; border: 2px solid #0284c7; color: #075985; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .claim-where i { font-size: 16px; }

        .quick-actions { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); }
        .actions-title { font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 14px; }
        .action-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .action-btn { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .action-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateY(-2px); }
        .action-icon { font-size: 20px; margin-bottom: 6px; color: #10b981; }
        .action-label { font-size: 12px; font-weight: 600; color: #475569; }

        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #e0e0e0; border-top-color: #10b981; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            body { padding: 20px 16px; }
            .dashboard-card { padding: 20px; }
            .balance-amount { font-size: 32px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-card">
            <div class="card-content">
                <div class="top-section">
                    <div class="user-name" id="userName"><span class="spinner"></span> Loading...</div>
                    <button class="fund-button" onclick="goToPlans()">+ Invest</button>
                </div>
                <div class="balance-section">
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount" id="totalBalance"><span class="spinner"></span></div>
                    <div class="balance-change" id="balanceChange"><span class="spinner"></span></div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Invested</div>
                <div class="stat-value" id="invested"><span class="spinner"></span></div>
                <div class="stat-trend" id="investedCount"><span class="spinner"></span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available</div>
                <div class="stat-value" id="available"><span class="spinner"></span></div>
                <div class="stat-trend">Ready to invest</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Claimed</div>
                <div class="stat-value" id="totalClaimed"><span class="spinner"></span></div>
                <div class="stat-trend" id="claimedTrend"><span class="spinner"></span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total ROI</div>
                <div class="stat-value" id="totalROI"><span class="spinner"></span></div>
                <div class="stat-trend">Return on Investment</div>
            </div>
        </div>

        <div class="claim-where">
            <i class="fas fa-info-circle"></i>
            <strong>Where to Claim:</strong> Scroll down to your active plans and click the claim button!
        </div>

        <div class="pending-section" id="pendingSection" style="display: none;">
            <div class="pending-title"><i class="fas fa-hand-holding-usd"></i>Pending Claims</div>
            <div class="pending-amount">
                <div class="pending-label">Total Claimable</div>
                <div class="pending-value" id="totalPending">$0.00</div>
            </div>
            <button class="claim-all-btn" id="claimAllBtn" onclick="claimAll()">Claim All Earnings</button>
        </div>

        <div class="plans-section">
            <div class="plans-title"><i class="fas fa-chart-line"></i>Active Investment Plans</div>
            <div id="plansList"><div class="no-plans">No active investment plans yet</div></div>
        </div>

        <div class="quick-actions">
            <div class="actions-title">Quick Actions</div>
            <div class="action-buttons">
                <div class="action-btn" onclick="goToPortfolio()">
                    <div class="action-icon"><i class="fas fa-chart-pie"></i></div>
                    <div class="action-label">Portfolio</div>
                </div>
                <div class="action-btn" onclick="goToWithdraw()">
                    <div class="action-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="action-label">Withdraw</div>
                </div>
                <div class="action-btn" onclick="goToPlans()">
                    <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                    <div class="action-label">Invest</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import { auth, database } from "./lib/firebase.js";

        let currentUser = null;
        let allPlans = {};

        window.goToPortfolio = () => window.location.href = '/portfolio.html';
        window.goToWithdraw = () => window.location.href = '/withdraw.html';
        window.goToPlans = () => window.location.href = '/plans.html';

        function calculatePendingEarnings(plan) {
            const now = Date.now();
            const { startDate, endDate, totalReturns, lastClaim = startDate, claimedAmount = 0 } = plan;
            const totalDuration = endDate - startDate;
            const shouldHaveEarned = (totalReturns * (now - startDate)) / totalDuration;
            return Math.max(0, Math.min(shouldHaveEarned - claimedAmount, totalReturns - claimedAmount));
        }

        window.claimEarnings = async (planId) => {
            if (!currentUser) return;
            const plan = allPlans[planId];
            if (!plan) return;

            const amount = calculatePendingEarnings(plan);
            if (amount < 0.01) return;

            const userRef = ref(database, `users/${currentUser.uid}`);
            try {
                const snap = await get(userRef);
                const userData = snap.val();
                const now = Date.now();
                const claimedAmount = (plan.claimedAmount || 0) + amount;
                const isFullyClaimed = claimedAmount >= plan.totalReturns;

                await update(userRef, {
                    available: (userData.available || 0) + amount,
                    totalBalance: (userData.totalBalance || 0) + amount,
                    totalClaimed: (userData.totalClaimed || 0) + amount,
                    [`activePlans/${planId}/claimedAmount`]: claimedAmount,
                    [`activePlans/${planId}/lastClaim`]: now,
                    [`activePlans/${planId}/isActive`]: !isFullyClaimed,
                    ...(isFullyClaimed && {
                        invested: Math.max(0, (userData.invested || 0) - plan.amount),
                        [`activePlans/${planId}/completedAt`]: now
                    }),
                    updatedAt: new Date().toISOString()
                });

                alert(`âœ… Successfully claimed $${amount.toFixed(2)}!`);
            } catch (error) {
                console.error('Claim error:', error);
                alert('Failed to claim. Please try again.');
            }
        };

        window.claimAll = async () => {
            if (!currentUser || !allPlans) return;
            
            let totalToClaim = 0;
            const updates = {};
            const now = Date.now();

            Object.entries(allPlans).forEach(([planId, plan]) => {
                if (!plan.isActive) return;
                const pending = calculatePendingEarnings(plan);
                if (pending >= 0.01) {
                    totalToClaim += pending;
                    const claimedAmount = (plan.claimedAmount || 0) + pending;
                    const isFullyClaimed = claimedAmount >= plan.totalReturns;
                    
                    updates[`activePlans/${planId}/claimedAmount`] = claimedAmount;
                    updates[`activePlans/${planId}/lastClaim`] = now;
                    updates[`activePlans/${planId}/isActive`] = !isFullyClaimed;
                    if (isFullyClaimed) {
                        updates[`activePlans/${planId}/completedAt`] = now;
                    }
                }
            });

            if (totalToClaim < 0.01) {
                alert('No earnings to claim yet');
                return;
            }

            const userRef = ref(database, `users/${currentUser.uid}`);
            try {
                const snap = await get(userRef);
                const userData = snap.val();

                await update(userRef, {
                    ...updates,
                    available: (userData.available || 0) + totalToClaim,
                    totalBalance: (userData.totalBalance || 0) + totalToClaim,
                    totalClaimed: (userData.totalClaimed || 0) + totalToClaim,
                    updatedAt: new Date().toISOString()
                });

                alert(`âœ… Successfully claimed $${totalToClaim.toFixed(2)}!`);
            } catch (error) {
                console.error('Claim all error:', error);
                alert('Failed to claim. Please try again.');
            }
        };

        function getPlanDisplayName(type) {
            const names = {
                'Weekly': 'Weekly Plan',
                'Monthly-10.5': 'Monthly 10.5%',
                'Monthly-11.5': 'Monthly Premium',
                'Yearly': 'Annual Plan'
            };
            return names[type] || type;
        }

        function updateDashboard(userData) {
            const displayName = userData.fullName || userData.email?.split('@')[0] || 'Investor';
            document.getElementById('userName').textContent = displayName;

            const totalBalance = userData.totalBalance || 0;
            const invested = userData.invested || 0;
            const available = userData.available || 0;
            const totalClaimed = userData.totalClaimed || 0;

            document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
            document.getElementById('balanceChange').textContent = `$${available.toFixed(2)} Available`;
            document.getElementById('invested').textContent = `$${invested.toFixed(2)}`;
            document.getElementById('available').textContent = `$${available.toFixed(2)}`;
            document.getElementById('totalClaimed').textContent = `$${totalClaimed.toFixed(2)}`;

            const activePlansObj = userData.activePlans || {};
            allPlans = activePlansObj;
            const activePlansArray = Object.entries(activePlansObj)
                .map(([id, plan]) => ({ id, ...plan }))
                .filter(p => p.isActive);

            const planCount = activePlansArray.length;
            document.getElementById('investedCount').textContent = `${planCount} active ${planCount === 1 ? 'plan' : 'plans'}`;
            document.getElementById('claimedTrend').textContent = `Total earnings`;

            const totalROI = invested > 0 ? ((totalClaimed / invested) * 100) : 0;
            document.getElementById('totalROI').textContent = `${totalROI.toFixed(2)}%`;

            let totalPending = 0;
            const plansList = document.getElementById('plansList');
            
            if (planCount > 0) {
                plansList.innerHTML = activePlansArray.map(plan => {
                    const pending = calculatePendingEarnings(plan);
                    totalPending += pending;
                    const claimed = plan.claimedAmount || 0;
                    const progress = ((claimed + pending) / plan.totalReturns) * 100;
                    const canClaim = pending >= 0.01;

                    return `
                        <div class="plan-item">
                            <div class="plan-header">
                                <div class="plan-info">
                                    <h4>${getPlanDisplayName(plan.type)}</h4>
                                    <p>$${plan.dailyIncome.toFixed(2)}/day â€¢ ${plan.returnRate}% ROI</p>
                                </div>
                                <div class="plan-amount">
                                    <div class="value">$${plan.amount.toFixed(2)}</div>
                                    <div class="return">+$${(claimed + pending).toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div class="plan-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(100, progress)}%"></div>
                                </div>
                                <div class="progress-info">
                                    <span>${Math.min(100, progress).toFixed(1)}% Complete</span>
                                    <span>$${(claimed + pending).toFixed(2)} / $${plan.totalReturns.toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="earnings-row">
                                <div class="earning-item">
                                    <div class="earning-label">Pending</div>
                                    <div class="earning-value pending">$${pending.toFixed(2)}</div>
                                </div>
                                <div class="earning-item">
                                    <div class="earning-label">Claimed</div>
                                    <div class="earning-value claimed">$${claimed.toFixed(2)}</div>
                                </div>
                                <div class="earning-item">
                                    <div class="earning-label">Target</div>
                                    <div class="earning-value">$${plan.totalReturns.toFixed(2)}</div>
                                </div>
                            </div>

                            <button class="claim-btn" ${!canClaim ? 'disabled' : ''} 
                                    onclick="claimEarnings('${plan.id}')">
                                ${canClaim ? `ðŸ’° Claim $${pending.toFixed(2)} Now` : 'Nothing to Claim Yet'}
                            </button>
                        </div>
                    `;
                }).join('');

                const pendingSection = document.getElementById('pendingSection');
                if (totalPending >= 0.01) {
                    pendingSection.style.display = 'block';
                    document.getElementById('totalPending').textContent = `$${totalPending.toFixed(2)}`;
                } else {
                    pendingSection.style.display = 'none';
                }
            } else {
                plansList.innerHTML = '<div class="no-plans">No active investment plans yet</div>';
                document.getElementById('pendingSection').style.display = 'none';
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(database, `users/${user.uid}`);
                
                onValue(userRef, (snap) => {
                    if (snap.exists()) {
                        updateDashboard(snap.val());
                        setInterval(() => updateDashboard(snap.val()), 5000);
                    }
                });
            } else {
                window.location.href = '/login.html';
            }
        });
    </script>
</body>
</html>
