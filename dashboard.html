<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #fafafa; min-height: 100vh; padding: 60px 20px 100px 20px; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 200px; }

        .dashboard-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 24px; padding: 24px; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.25), 0 2px 8px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .dashboard-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, transparent 40%, rgba(255, 255, 255, 0.25) 50%, transparent 60%, transparent); animation: shine 3s infinite; }
        @keyframes shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        .card-content { position: relative; z-index: 1; }
        .top-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; }
        .user-name { color: white; font-size: 18px; font-weight: 600; flex: 1; }
        .fund-button { background: white; color: #10b981; border: none; border-radius: 8px; padding: 6px 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); white-space: nowrap; flex-shrink: 0; }
        .fund-button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .balance-section { margin-top: 8px; }
        .balance-label { color: rgba(255, 255, 255, 0.85); font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .balance-amount { color: white; font-size: 36px; font-weight: 700; margin-bottom: 6px; }
        .balance-change { color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .stat-label { color: #64748b; font-size: 12px; font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { color: #0f172a; font-size: 20px; font-weight: 700; }
        .stat-trend { color: #10b981; font-size: 11px; font-weight: 600; margin-top: 4px; }

        .income-section { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); margin-bottom: 20px; }
        .income-title { font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .income-title i { color: #10b981; font-size: 18px; }
        .income-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .income-item { background: #f8fafc; border-radius: 12px; padding: 14px; text-align: center; }
        .income-item-label { color: #64748b; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
        .income-item-value { color: #10b981; font-size: 18px; font-weight: 700; }

        .plans-section { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); margin-bottom: 20px; }
        .plans-title { font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .plans-title i { color: #10b981; }
        .no-plans { text-align: center; padding: 20px; color: #94a3b8; font-size: 14px; }
        .plan-item { background: #f8fafc; border-left: 4px solid #10b981; border-radius: 8px; padding: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .plan-info h4 { color: #0f172a; font-size: 14px; margin-bottom: 4px; font-weight: 600; }
        .plan-info p { color: #64748b; font-size: 12px; }
        .plan-amount { text-align: right; }
        .plan-amount .value { color: #10b981; font-size: 16px; font-weight: 700; }
        .plan-amount .return { color: #059669; font-size: 12px; margin-top: 4px; }

        .quick-actions { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); }
        .actions-title { font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 14px; }
        .action-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .action-btn { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .action-btn:hover { background: #f1f5f9; border-color: #cbd5e1; transform: translateY(-2px); }
        .action-icon { font-size: 20px; margin-bottom: 6px; color: #10b981; }
        .action-label { font-size: 12px; font-weight: 600; color: #475569; }

        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #e0e0e0; border-top-color: #10b981; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            body { padding: 20px 16px; }
            .dashboard-card { padding: 20px; }
            .balance-amount { font-size: 32px; }
            .stats-grid { grid-template-columns: 1fr; }
            .income-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-card">
            <div class="card-content">
                <div class="top-section">
                    <div class="user-name" id="userName"><span class="spinner"></span> Loading...</div>
                    <button class="fund-button" id="fundButton">+ Fund</button>
                </div>
                <div class="balance-section">
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount" id="totalBalance"><span class="spinner"></span></div>
                    <div class="balance-change" id="balanceChange"><span class="spinner"></span></div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Invested</div>
                <div class="stat-value" id="invested"><span class="spinner"></span></div>
                <div class="stat-trend" id="investedCount"><span class="spinner"></span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available</div>
                <div class="stat-value" id="available"><span class="spinner"></span></div>
                <div class="stat-trend">Ready to invest</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Income</div>
                <div class="stat-value" id="totalIncome"><span class="spinner"></span></div>
                <div class="stat-trend" id="incomeTrend"><span class="spinner"></span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total ROI</div>
                <div class="stat-value" id="totalROI"><span class="spinner"></span></div>
                <div class="stat-trend">Return on Investment</div>
            </div>
        </div>

        <div class="income-section">
            <div class="income-title"><i class="fas fa-money-bill-wave"></i>Current Income</div>
            <div class="income-grid">
                <div class="income-item">
                    <div class="income-item-label">Today's Income</div>
                    <div class="income-item-value" id="todayIncome">$0</div>
                </div>
                <div class="income-item">
                    <div class="income-item-label">Total Earned</div>
                    <div class="income-item-value" id="totalEarned">$0</div>
                </div>
            </div>
        </div>

        <div class="plans-section">
            <div class="plans-title"><i class="fas fa-chart-line"></i>Active Investment Plans</div>
            <div id="plansList"><div class="no-plans">No active investment plans yet</div></div>
        </div>

        <div class="quick-actions">
            <div class="actions-title">Quick Actions</div>
            <div class="action-buttons">
                <div class="action-btn" onclick="goToPortfolio()">
                    <div class="action-icon"><i class="fas fa-chart-pie"></i></div>
                    <div class="action-label">Portfolio</div>
                </div>
                <div class="action-btn" onclick="goToWithdraw()">
                    <div class="action-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="action-label">Withdraw</div>
                </div>
                <div class="action-btn" onclick="goToPlans()">
                    <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                    <div class="action-label">Invest</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import { auth, database } from "./lib/firebase.js";

        let currentUser = null;

        // Fund button handler
        document.getElementById('fundButton')?.addEventListener('click', function(e) {
            e.preventDefault();
            try {
                if (window.parent && typeof window.parent.openFundingModal === 'function') {
                    window.parent.openFundingModal();
                } else {
                    window.parent.postMessage({ type: 'OPEN_FUNDING_MODAL' }, '*');
                }
            } catch (err) {
                window.location.href = '/fund.html';
            }
        });

        window.goToPortfolio = () => window.location.href = '/portfolio.html';
        window.goToWithdraw = () => window.location.href = '/withdraw.html';
        window.goToPlans = () => window.location.href = '/plans.html';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(database, `users/${user.uid}`);
                
                onValue(userRef, (snap) => {
                    if (snap.exists()) {
                        updateDashboard(snap.val());
                    }
                });
            } else {
                window.location.href = '/login.html';
            }
        });

        function updateDashboard(userData) {
            // User name
            const displayName = userData.fullName || userData.email?.split('@')[0] || 'Investor';
            document.getElementById('userName').textContent = displayName;

            // Balances
            const totalBalance = userData.totalBalance || 0;
            const invested = userData.invested || 0;
            const available = userData.available || 0;
            const totalIncome = userData.totalIncome || 0;
            const todayIncome = userData.todayIncome || 0;

            document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
            document.getElementById('balanceChange').textContent = `$${(userData.balanceChange || 0).toFixed(2)} Today`;
            document.getElementById('invested').textContent = `$${invested.toFixed(2)}`;
            document.getElementById('available').textContent = `$${available.toFixed(2)}`;
            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('todayIncome').textContent = `$${todayIncome.toFixed(2)}`;
            document.getElementById('totalEarned').textContent = `$${totalIncome.toFixed(2)}`;

            // Active Plans - Read from activePlans object
            const activePlansObj = userData.activePlans || {};
            const activePlansArray = Object.entries(activePlansObj).map(([id, plan]) => ({
                id,
                ...plan
            }));

            const planCount = activePlansArray.length;
            document.getElementById('investedCount').textContent = `${planCount} active ${planCount === 1 ? 'plan' : 'plans'}`;
            document.getElementById('incomeTrend').textContent = planCount > 0 ? `From ${planCount} ${planCount === 1 ? 'plan' : 'plans'}` : 'No plans yet';

            // Calculate ROI
            const totalROI = invested > 0 ? ((totalIncome / invested) * 100) : 0;
            document.getElementById('totalROI').textContent = `${totalROI.toFixed(2)}%`;

            // Display plans
            const plansList = document.getElementById('plansList');
            if (planCount > 0) {
                plansList.innerHTML = activePlansArray.map(plan => {
                    const planName = getPlanDisplayName(plan.type);
                    const earnedSoFar = plan.earnedSoFar || 0;
                    const dailyIncome = plan.dailyIncome || 0;
                    const totalReturns = plan.totalReturns || 0;
                    const progressPercent = totalReturns > 0 ? ((earnedSoFar / totalReturns) * 100).toFixed(1) : 0;

                    return `
                        <div class="plan-item">
                            <div class="plan-info">
                                <h4>${planName}</h4>
                                <p>$${dailyIncome.toFixed(2)}/day • ${progressPercent}% earned</p>
                            </div>
                            <div class="plan-amount">
                                <div class="value">$${(plan.amount || 0).toFixed(2)}</div>
                                <div class="return">+$${earnedSoFar.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                plansList.innerHTML = '<div class="no-plans">No active investment plans yet</div>';
            }
        }

        function getPlanDisplayName(type) {
            const names = {
                'Weekly': 'Weekly Plan',
                'Monthly-10.5': 'Monthly 10.5%',
                'Monthly-11.5': 'Monthly Premium 11.5%',
                'Yearly': 'Annual Plan'
            };
            return names[type] || type;
        }
    </script>
</body>
             </html>
