<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#fafafa;min-height:100vh;padding:60px 20px 100px}
        .container{max-width:500px;margin:0 auto;padding-bottom:200px}
        .dashboard-card{background:linear-gradient(135deg,#10b981,#059669);border-radius:24px;padding:24px;box-shadow:0 8px 32px rgba(16,185,129,.25);position:relative;overflow:hidden;margin-bottom:20px;border:1px solid rgba(255,255,255,.2)}
        .dashboard-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,transparent 40%,rgba(255,255,255,.25) 50%,transparent 60%,transparent);animation:shine 3s infinite}
        @keyframes shine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
        .card-content{position:relative;z-index:1}
        .user-name{color:white;font-size:18px;font-weight:600;margin-bottom:8px}
        .balance-label{color:rgba(255,255,255,.85);font-size:13px;margin-bottom:6px}
        .balance-amount{color:white;font-size:36px;font-weight:700;margin-bottom:6px}
        .balance-change{color:rgba(255,255,255,.95);font-size:14px;font-weight:600}
        .button-row{display:flex;gap:10px;margin-top:16px}
        .action-button{flex:1;background:white;color:#10b981;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:600;cursor:pointer;transition:transform .3s}
        .action-button:hover{transform:translateY(-2px)}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background:white;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
        .stat-label{color:#64748b;font-size:12px;font-weight:500;margin-bottom:6px;text-transform:uppercase}
        .stat-value{color:#0f172a;font-size:20px;font-weight:700}
        .stat-trend{color:#10b981;font-size:11px;font-weight:600;margin-top:4px}
        .section{background:white;border-radius:16px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px}
        .section-title{font-size:14px;font-weight:600;color:#0f172a;margin-bottom:16px}
        .pending-amount{text-align:center;padding:20px;background:#fef3c7;border-radius:12px;margin-bottom:16px}
        .pending-label{color:#92400e;font-size:12px;font-weight:600;margin-bottom:8px;text-transform:uppercase}
        .pending-value{color:#f59e0b;font-size:32px;font-weight:700}
        .plan-item{background:#f8fafc;border-left:4px solid #10b981;border-radius:8px;padding:14px;margin-bottom:12px}
        .plan-header{display:flex;justify-content:space-between;margin-bottom:10px}
        .plan-info h4{color:#0f172a;font-size:14px;margin-bottom:4px;font-weight:600}
        .plan-status{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;background:#dcfce7;color:#059669}
        .btn{width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer}
        .btn:hover{opacity:.9}
        .btn-sm{padding:10px;font-size:13px;font-weight:600;margin-top:10px}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7)}
        .modal-content{background:white;margin:10% auto;padding:30px;border-radius:20px;max-width:450px;box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:20px;font-weight:700;color:#0f172a}
        .close-btn{background:none;border:none;font-size:28px;color:#64748b;cursor:pointer}
        .input-group{margin:20px 0}
        .input-label{font-size:13px;color:#64748b;margin-bottom:8px;font-weight:600;display:block}
        .input-field{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px}
        .warning{background:#fef3c7;color:#92400e;padding:12px;border-radius:8px;font-size:13px;margin:16px 0}
        .spinner{display:inline-block;width:12px;height:12px;border:2px solid #e0e0e0;border-top-color:#10b981;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-card">
            <div class="card-content">
                <div class="user-name" id="userName"><span class="spinner"></span> Loading...</div>
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="totalBalance"><span class="spinner"></span></div>
                <div class="balance-change" id="balanceChange"><span class="spinner"></span></div>
                <div class="button-row">
                    <button class="action-button" onclick="openModal()"><i class="fas fa-wallet"></i> Fund</button>
                    <button class="action-button" onclick="location.href='/plans.html'"><i class="fas fa-chart-line"></i> Invest</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Invested</div>
                <div class="stat-value" id="invested"><span class="spinner"></span></div>
                <div class="stat-trend" id="investedCount"><span class="spinner"></span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available</div>
                <div class="stat-value" id="available"><span class="spinner"></span></div>
                <div class="stat-trend">Ready to invest</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Claimed</div>
                <div class="stat-value" id="totalClaimed"><span class="spinner"></span></div>
                <div class="stat-trend">Total earnings</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total ROI</div>
                <div class="stat-value" id="totalROI"><span class="spinner"></span></div>
                <div class="stat-trend">Return on Investment</div>
            </div>
        </div>

        <div class="section" id="pendingSection" style="display:none">
            <div class="section-title"><i class="fas fa-hand-holding-usd"></i> Pending Claims</div>
            <div class="pending-amount">
                <div class="pending-label">Total Claimable</div>
                <div class="pending-value" id="totalPending">$0.00</div>
            </div>
            <button class="btn" onclick="claimAll()">Claim All Earnings</button>
        </div>

        <div class="section">
            <div class="section-title"><i class="fas fa-chart-line"></i> Active Investment Plans</div>
            <div id="plansList"><div style="text-align:center;padding:20px;color:#94a3b8">No active plans</div></div>
        </div>
    </div>

    <div id="fundModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Fund Your Account</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="input-group">
                <label class="input-label">Select Payment Method</label>
                <select id="paymentMethod" class="input-field">
                    <option value="">Choose payment method...</option>
                    <option value="Revolut">Revolut</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Cash App">Cash App</option>
                    <option value="Venmo">Venmo</option>
                    <option value="Chime">Chime</option>
                    <option value="IBAN">IBAN</option>
                    <option value="Western Union">Western Union</option>
                    <option value="MoneyGram">MoneyGram</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Amount to Fund (USD)</label>
                <input type="number" id="amountSent" class="input-field" placeholder="Enter amount in USD" min="1" step="0.01">
            </div>
            <div class="warning"><strong>ℹ️ Next Step:</strong> After clicking continue, you'll be redirected to WhatsApp to complete your funding request.</div>
            <button class="btn" onclick="submitFunding()">Continue to WhatsApp</button>
        </div>
    </div>

    <script type="module">
        import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import{getDatabase,ref,get,update,push,onValue}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import{auth,database}from"./lib/firebase.js";

        let user,plans={};

        window.openModal=()=>document.getElementById('fundModal').style.display='block';
        window.closeModal=()=>{document.getElementById('fundModal').style.display='none';document.getElementById('amountSent').value='';document.getElementById('paymentMethod').value=''};

        window.submitFunding=async()=>{
            if(!user)return;
            const method=document.getElementById('paymentMethod').value;
            const amt=parseFloat(document.getElementById('amountSent').value);
            if(!method)return alert('Please select a payment method');
            if(!amt||amt<=0)return alert('Please enter a valid amount');
            try{
                await push(ref(database,'fundingRequests'),{
                    userId:user.uid,
                    userEmail:user.email,
                    userName:user.displayName||user.email,
                    amount:amt,
                    paymentMethod:method,
                    status:'pending',
                    createdAt:new Date().toISOString(),
                    timestamp:Date.now()
                });
                const msg=`Hello! I would like to fund my investment account.\n\n*Account Details:*\nEmail: ${user.email}\n\n*Funding Request:*\nPayment Method: ${method}\nAmount: $${amt.toFixed(2)} USD\n\nPlease provide payment instructions. Thank you!`;
                window.open(`https://wa.me/447940228929?text=${encodeURIComponent(msg)}`,'_blank');
                closeModal();
                alert('✅ Request saved! Opening WhatsApp...');
            }catch(e){alert('Failed to submit. Please try again.')}
        };

        const calcPending=p=>{
            const now=Date.now();
            if(now>=p.endDate)return Math.max(0,p.totalReturns-(p.claimedAmount||0));
            const elapsed=now-p.startDate;
            const earned=(p.totalReturns*elapsed)/(p.endDate-p.startDate);
            return Math.max(0,earned-(p.claimedAmount||0));
        };

        window.claimEarnings=async id=>{
            if(!user)return;
            const p=plans[id];
            if(!p)return;
            const amt=calcPending(p);
            if(amt<.01)return;
            try{
                const snap=await get(ref(database,`users/${user.uid}`));
                const d=snap.val();
                const claimed=(p.claimedAmount||0)+amt;
                await update(ref(database,`users/${user.uid}`),{
                    available:(d.available||0)+amt,
                    totalBalance:(d.totalBalance||0)+amt,
                    totalClaimed:(d.totalClaimed||0)+amt,
                    [`activePlans/${id}/claimedAmount`]:claimed,
                    [`activePlans/${id}/lastClaim`]:Date.now(),
                    updatedAt:new Date().toISOString()
                });
                alert(`✅ Successfully claimed $${amt.toFixed(2)}!`);
            }catch(e){alert('Failed to claim. Try again.')}
        };

        window.claimAll=async()=>{
            if(!user||!plans)return;
            let total=0;
            const updates={};
            Object.entries(plans).forEach(([id,p])=>{
                if(!p.isActive)return;
                const pending=calcPending(p);
                if(pending>=.01){
                    total+=pending;
                    const claimed=(p.claimedAmount||0)+pending;
                    updates[`activePlans/${id}/claimedAmount`]=claimed;
                    updates[`activePlans/${id}/lastClaim`]=Date.now();
                }
            });
            if(total<.01)return alert('No earnings to claim yet');
            try{
                const snap=await get(ref(database,`users/${user.uid}`));
                const d=snap.val();
                await update(ref(database,`users/${user.uid}`),{
                    ...updates,
                    available:(d.available||0)+total,
                    totalBalance:(d.totalBalance||0)+total,
                    totalClaimed:(d.totalClaimed||0)+total,
                    updatedAt:new Date().toISOString()
                });
                alert(`✅ Successfully claimed $${total.toFixed(2)}!`);
            }catch(e){alert('Failed to claim. Try again.')}
        };

        const updateUI=d=>{
            document.getElementById('userName').textContent=d.fullName||d.email?.split('@')[0]||'Investor';
            document.getElementById('totalBalance').textContent=`$${(d.totalBalance||0).toFixed(2)}`;
            document.getElementById('balanceChange').textContent=`$${(d.available||0).toFixed(2)} Available`;
            document.getElementById('invested').textContent=`$${(d.invested||0).toFixed(2)}`;
            document.getElementById('available').textContent=`$${(d.available||0).toFixed(2)}`;
            document.getElementById('totalClaimed').textContent=`$${(d.totalClaimed||0).toFixed(2)}`;
            const roi=d.invested>0?((d.totalClaimed||0)/d.invested*100):0;
            document.getElementById('totalROI').textContent=`${roi.toFixed(2)}%`;
            
            plans=d.activePlans||{};
            const arr=Object.entries(plans).map(([id,p])=>({id,...p}));
            let totalPending=0;
            
            if(arr.length>0){
                document.getElementById('plansList').innerHTML=arr.map(p=>{
                    const pending=calcPending(p);
                    if(p.isActive)totalPending+=pending;
                    return`<div class="plan-item"><div class="plan-header"><div class="plan-info"><h4>${p.type} Plan</h4><span class="plan-status">${p.isActive?'● Active':'✓ Completed'}</span></div><div>$${p.amount.toFixed(2)}</div></div>${p.isActive?`<button class="btn btn-sm"${pending<.01?' disabled':''} onclick="claimEarnings('${p.id}')">${pending>=.01?`💰 Claim $${pending.toFixed(2)}`:'Nothing to Claim Yet'}</button>`:''}</div>`;
                }).join('');
                if(totalPending>=.01){
                    document.getElementById('pendingSection').style.display='block';
                    document.getElementById('totalPending').textContent=`$${totalPending.toFixed(2)}`;
                }
            }
        };

        onAuthStateChanged(auth,u=>{
            if(u){
                user=u;
                onValue(ref(database,`users/${u.uid}`),s=>{if(s.exists())updateUI(s.val())});
            }else location.href='/login.html';
        });
    </script>
</body>
    </html>
